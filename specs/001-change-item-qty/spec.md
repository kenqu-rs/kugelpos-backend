# Feature Specification: カート内商品数量変更API

**Feature Branch**: `001-change-item-qty`
**Created**: 2026-02-24
**Status**: Draft
**Input**: User description: "指定商品の商品数量を変更するAPI"

## Clarifications

### Session 2026-02-24

- Q: キャンセル済み（is_cancelled=True）の行Noに対して数量変更を要求した場合、どう扱うべきか？ → A: エラーを返す（キャンセル済み行は変更不可）
- Q: キャンセル済み行を指定した場合のエラーコードは「行Not Found」と同じにすべきか、専用コードを用意すべきか？ → A: LINE_ITEM_NOT_FOUND と同じエラーコードで返す（シンプルに統一）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 正常な数量変更 (Priority: P1)

POSオペレーターがカートに登録済みの商品の数量を変更したい場合、行Noと新しい数量を指定して変更できる。

**Why this priority**: カートへの商品登録後に数量を修正する操作は日常的に発生するPOS業務の中核機能であるため。

**Independent Test**: 商品が登録済みのカートに対して数量変更リクエストを送信し、レスポンスのカート明細の数量が指定した値に更新されていることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** カートに商品が1件登録されている（line_no=1）、**When** line_no=1、quantity=3 で数量変更を要求する、**Then** カート明細の行No 1 の数量が 3 に更新され、更新後のカート情報が返される
2. **Given** カートに複数商品が登録されている、**When** 特定の行Noと数量を指定する、**Then** 指定した行のみ数量が更新され、他の行は変更されない

---

### User Story 2 - 存在しない行Noの指定 (Priority: P2)

POSオペレーターが誤ってカートに存在しない行Noを指定した場合、システムが適切なエラーを返し、カートの状態は変更されない。

**Why this priority**: 誤操作によるカートデータの破損を防ぐためのバリデーションはユーザー体験・データ整合性の観点から重要。

**Independent Test**: カートに存在しない行No（例: line_no=999）を指定してリクエストを送信し、エラーレスポンスが返り、カートの内容が変わらないことで独立テスト可能。

**Acceptance Scenarios**:

1. **Given** カートに行No 1 の商品のみ登録されている、**When** line_no=999、quantity=2 で数量変更を要求する、**Then** エラーが返され、カートの内容は変更されない

---

### User Story 3 - 数量上限超過 (Priority: P3)

POSオペレーターが最大許容数量（99）を超える数量を指定した場合、システムがエラーを返し、カートは変更されない。

**Why this priority**: 業務上の数量制約を強制し、異常な注文を防ぐためのバリデーション。

**Independent Test**: 登録済みの行Noに対して quantity=100 のリクエストを送信し、エラーレスポンスが返ることで独立テスト可能。

**Acceptance Scenarios**:

1. **Given** カートに行No 1 の商品が登録されている、**When** line_no=1、quantity=100 で数量変更を要求する、**Then** エラーが返され、カートの数量は変更されない
2. **Given** カートに行No 1 の商品が登録されている、**When** line_no=1、quantity=99 で数量変更を要求する、**Then** 数量が 99 に更新され、正常レスポンスが返る

---

### User Story 4 - キャンセル済み行への変更試行 (Priority: P2)

POSオペレーターが既にキャンセル済みの明細行（is_cancelled=True）に対して数量変更を試みた場合、システムはエラーを返しカートの状態は変更されない。

**Why this priority**: キャンセル済み行の復活は業務上許容されず、データ整合性保護のために必須のバリデーション。

**Independent Test**: キャンセル済みの行Noを指定して数量変更リクエストを送信し、エラーレスポンスが返ることで独立テスト可能。

**Acceptance Scenarios**:

1. **Given** カートに行No 1 の商品が登録されており is_cancelled=True である、**When** line_no=1、quantity=2 で数量変更を要求する、**Then** エラーが返され、カートの内容は変更されない

---

### Edge Cases

- 数量に 0 や負の値を指定した場合はエラーとする（1以上99以下が有効範囲）
- カートが商品入力中（entering_item）以外の状態で数量変更を要求した場合、既存のステートマシンのルールに従いエラー
- キャンセル済み（is_cancelled=True）の行Noを指定した場合はエラーを返す（変更不可）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、カートに登録済みの商品の数量を行No（line_no）で指定して変更できなければならない
- **FR-002**: リクエストは行No（line_no）と新しい数量（quantity）の組み合わせを受け取らなければならない
- **FR-003**: カートに存在しない行Noが指定された場合、システムはエラーを返さなければならない
- **FR-004**: 数量が 99 を超える値が指定された場合、システムはエラーを返さなければならない
- **FR-005**: 数量が 1 未満の値が指定された場合、システムはエラーを返さなければならない
- **FR-006**: 数量変更はカートの商品入力中（entering_item）状態でのみ許可される
- **FR-007**: 数量変更後のカート全体の情報（明細・合計等）がレスポンスとして返されなければならない
- **FR-008**: 既存の数量変更ロジックを再利用し、計算ロジックの一貫性を保たなければならない
- **FR-009**: キャンセル済み（is_cancelled=True）の行Noが指定された場合、システムは LINE_ITEM_NOT_FOUND と同一のエラーコードでエラーを返さなければならない

### Key Entities

- **Cart（カート）**: 会計処理中の買い物かご。複数の明細行（LineItem）を持つ
- **LineItem（明細行）**: カート内の各商品行。行No（line_no）、商品コード、数量、金額、キャンセル状態（is_cancelled）等を持つ
- **行No（line_no）**: カート内で商品を一意に識別するための番号（1始まりの整数）。キャンセル済み行も含む全明細の通し番号

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: カートに登録済みの商品の数量変更操作が1回のAPIリクエストで完結する
- **SC-002**: 存在しない行No、キャンセル済み行No、無効な数量（1未満または99超）に対して、常に明確なエラーメッセージが返される
- **SC-003**: 数量変更後のカート情報が即座に反映され、レスポンスに更新済みの全明細情報が含まれる
- **SC-004**: 既存のカートAPIと同等のレスポンス形式・エラー形式で動作する

## Assumptions

- 数量の最大値は 99 とする（要件定義より）
- 数量の最小値は 1 とする（0以下は無効）
- 1回のリクエストで変更できる行Noは1件のみ（バルク変更は対象外）
- ステートマシンの状態チェックは既存の仕組みに委譲する
- レスポンス形式は既存のカートAPIレスポンスに準拠する
- キャンセル済み行も含む全明細の通し番号が line_no となる（配列インデックスベース）
