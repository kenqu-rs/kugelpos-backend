# Feature Specification: 複数商品の一括数量削減API

**Feature Branch**: `001-bulk-qty-reduce`
**Created**: 2026-02-23
**Status**: Draft

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 複数商品を一度に数量削減する (Priority: P1)

カートに複数の商品が入っている状態で、POS操作員が一度のAPI呼び出しで複数商品の数量をまとめて削減できる。たとえば、「商品Aを2個返品・取り消し、商品Bを1個返品・取り消し」という操作を1回のリクエストで完結させる。

**Why this priority**: POS業務における返品・修正操作の中核であり、個別に複数回APIを呼ぶ非効率を解消する最も重要なユースケース。

**Independent Test**: カートに複数商品を登録した後、一括削減APIを呼び出し、各商品の数量が正しく減少していることを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** カートに「ITEM001×5個、ITEM002×3個」が登録されている、**When** `[{item_code: "ITEM001", quantity: 2}, {item_code: "ITEM002", quantity: 1}]` で一括削減を要求する、**Then** カートが「ITEM001×3個、ITEM002×2個」に更新され、合計金額が再計算される
2. **Given** カートに1種類の商品だけが入っている、**When** その商品1件のみのリストで削減を要求する、**Then** 正常に削減され更新されたカートが返される

---

### User Story 2 - 存在しない商品コードを指定した場合のエラー処理 (Priority: P2)

カートに登録されていない商品コードを含む削減リストを送信した場合、システムがエラーを返し、カートの状態は変更されない。

**Why this priority**: データ整合性の確保に必須。誤った操作でカートが意図せず変更されることを防ぐ。

**Independent Test**: カートに存在しない商品コードを含むリストを送信し、エラーレスポンスが返り、カートが変更されていないことを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** カートに「ITEM001×5個」のみ登録されている、**When** `[{item_code: "ITEM999", quantity: 1}]`（存在しないコード）で削減要求する、**Then** エラーが返され、カートは変更されない
2. **Given** カートに「ITEM001×5個、ITEM002×3個」が登録されている、**When** 一部に存在しない商品コードを含むリストで削減要求する、**Then** エラーが返され、カート全体が変更されない（部分的な更新は行われない）

---

### User Story 3 - 削減数量が登録数量を超える場合のエラー処理 (Priority: P3)

指定した削減数量がカートの現在の商品登録数量を超える場合、システムがエラーを返し、カートの状態は変更されない。

**Why this priority**: 数量の整合性を保つために必須。マイナス数量や不整合なカート状態になることを防ぐ。

**Independent Test**: 現在の登録数量を超える削減数量を指定し、エラーが返り、カートが変更されていないことを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** カートに「ITEM001×2個」が登録されている、**When** `[{item_code: "ITEM001", quantity: 5}]`（登録数2を超える削減数5）で削減要求する、**Then** エラーが返され、カートの数量は変更されない
2. **Given** カートに「ITEM001×5個、ITEM002×1個」が登録されている、**When** ITEM002の削減数量が登録数を超えるリストを送る、**Then** エラーが返され、ITEM001も含めてカート全体が変更されない

---

### Edge Cases

- リストが空の場合（空配列 `[]`）のリクエストはどう扱うか？ → バリデーションエラーを返す（少なくとも1件必要）
- 同一商品コードがリスト内に重複して指定された場合は？ → バリデーションエラーを返す
- 削減数量に0または負の値が指定された場合は？ → バリデーションエラーを返す
- カートが存在しない・既にクローズされた状態でのリクエストは？ → 既存の認証・カートIDチェックと同様のエラーを返す

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、カートIDと商品コード＋削減数量のリストを受け取る一括数量削減エンドポイントを提供しなければならない
- **FR-002**: システムは、リスト内のすべての商品コードがカートに存在するかを検証し、1件でも存在しない場合はエラーを返さなければならない
- **FR-003**: システムは、各商品の削減数量が現在のカート登録数量を超えないことを検証し、超える場合はエラーを返さなければならない
- **FR-004**: システムは、すべての検証が通過した場合のみ、リスト内のすべての商品の数量を一括で削減しなければならない（全件成功か全件失敗のアトミック操作）
- **FR-005**: システムは、数量削減後にカートの合計金額・合計数量を再計算しなければならない
- **FR-006**: システムは、内部的に既存の単件数量更新ロジックを再利用して各商品の数量を更新しなければならない
- **FR-007**: リクエストのリストが空、または削減数量が0以下、または同一商品コードが重複している場合はバリデーションエラーを返さなければならない
- **FR-008**: APIレスポンスは既存のカートAPIと同一の形式（更新後のカート全体情報）で返さなければならない

### Key Entities

- **Cart（カート）**: 取引中の買い物かご。cart_idで識別され、複数のLineItemを持つ
- **LineItem（明細行）**: カート内の商品1行。line_no（行番号）、item_code（商品コード）、quantity（数量）、unit_price（単価）などを持つ
- **BulkQuantityReductionRequest（一括削減リクエスト）**: item_codeとquantity（削減数量）のペアのリスト

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: POS操作員が複数商品の数量削減を1回のAPI呼び出しで完結でき、従来の複数回呼び出しと比較して操作ステップ数が削減される
- **SC-002**: 一括削減APIが既存の単件更新APIと同等の応答速度で動作する（商品数に対してほぼ線形スケール）
- **SC-003**: 不正なリクエスト（存在しない商品コード、超過削減数量）に対して100%エラーが返され、カートデータが不整合になるケースが0件
- **SC-004**: リスト内のいずれかの商品でエラーが発生した場合、カート全体への部分的な変更が0件（アトミック性の保証）

## Assumptions

- 「数量削減」は現在の数量からの減算であり、設定（上書き）ではない。たとえば現在5個の商品に対して削減数量2を指定すると3個になる
- 数量が0になる削減（例：現在1個の商品を1個削減）は正常に処理され、カートから行が削除されるのではなく数量0として残る（既存の単件更新ロジックの挙動に準ずる）
- 認証・カートIDの検証は既存のミドルウェア・Dependsパターンで行われる
- 既存カートの状態機械（state machine）の制約（例：paying状態ではアイテム変更不可）はそのまま適用される
